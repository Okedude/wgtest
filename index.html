<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herr Winkelmann</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: 'Roboto Mono', monospace;
            color: #333;
            overflow: hidden;
            transition: background-color 2s ease-in-out;
            user-select: none;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            margin: auto;
            width: 100%;
        }
        canvas {
            background-color: #a4d3ff;
            border-radius: 10px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2);
            touch-action: none;
            width: 100%;
            max-width: 800px;
            height: auto;
            max-height: 600px;
        }
        .ui-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .stats-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
            gap: 10px;
        }
        .stat-item {
            font-size: 1.1em;
            font-weight: bold;
            flex-grow: 1;
        }
        .progress-bar {
            width: 80%;
            height: 25px;
            background-color: #ddd;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 5px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            transition: width 0.5s ease-out;
        }
        .info-message {
            margin-top: 15px;
            font-size: 1.2em;
            text-align: center;
            line-height: 1.4;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 0, 0, 0);
            color: white;
            font-size: 3em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            opacity: 0;
            visibility: hidden;
            transition: background-color 2s, opacity 2s;
            z-index: 1000;
        }
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .win-overlay {
            background-color: rgba(76, 175, 80, 0.7);
        }
        .button, .lobby-button {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, #f8a141, #ff7e5f);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        .button:hover, .lobby-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }
        .button:active, .lobby-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .level-info {
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        /* Dialogue box styles */
        .dialogue-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .dialogue-box {
            background-color: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .dialogue-title {
            font-size: 1.5em;
            font-weight: bold;
        }
        .dialogue-text {
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 10px;
            min-height: 80px;
            background-color: #f9f9f9;
            text-align: left;
            overflow-y: auto;
            max-height: 200px;
            line-height: 1.4;
        }
        .dialogue-input-container {
            display: flex;
            gap: 10px;
        }
        .dialogue-input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 1em;
        }
        .dialogue-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #ff7e5f;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dialogue-button:hover {
            background: #feb47b;
        }
        .dialogue-close-button {
            align-self: flex-end;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        
        /* --- Login/Registration UI --- */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-container h2 {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .auth-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        .auth-container input:focus {
            outline: none;
            border-color: #ff7e5f;
        }
        .auth-container button {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, #f8a141, #ff7e5f);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .auth-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }
        .auth-container button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .auth-container p {
            margin-top: 15px;
            font-size: 0.9em;
        }
        .auth-container a {
            color: #ff7e5f;
            cursor: pointer;
            text-decoration: underline;
        }
        #userInfo {
            font-size: 1em;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Button styles for Google login */
        #googleLoginButton {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: linear-gradient(145deg, #4285F4, #34609a);
            color: white;
            margin-top: 15px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            font-size: 1em;
        }
        #googleLoginButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }
        #googleLoginButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #googleLoginButton svg {
            width: 20px;
            height: 20px;
        }
        
        /* Leaderboard and user list */
        .player-list {
            margin-top: 20px;
            width: 100%;
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: left;
        }
        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .player-item:last-child {
            border-bottom: none;
        }
        .player-item.current {
            font-weight: bold;
            color: #ff7e5f;
        }

        /* Lobby UI */
        .lobby-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }
        .lobby-container h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .lobby-code-display {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 5px;
            background-color: #f0f0f0;
            padding: 15px 25px;
            border-radius: 10px;
        }
        .lobby-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.5em;
            text-align: center;
            letter-spacing: 2px;
            font-family: 'Roboto Mono', monospace;
        }
        .lobby-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .start-game-button {
            background: #4CAF50;
            color: white;
            display: none;
        }
        .lobby-status {
            font-style: italic;
            color: #555;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer" style="display: none;">
        <div id="loadingMessage">Lade Spiel...</div>
        <div id="authForms" style="display: none;">
            <div id="loginForm">
                <h2>Anmelden</h2>
                <input type="email" id="loginEmail" placeholder="E-Mail">
                <input type="password" id="loginPassword" placeholder="Passwort">
                <button id="loginButton">Anmelden</button>
                <p>Noch kein Konto? <a href="#" id="showRegister">Jetzt registrieren</a></p>
                <p id="authError" style="color: red;"></p>
            </div>
            <div id="registerForm" style="display: none;">
                <h2>Registrieren</h2>
                <input type="email" id="registerEmail" placeholder="E-Mail">
                <input type="password" id="registerPassword" placeholder="Passwort">
                <button id="registerButton">Registrieren</button>
                <p>Bereits ein Konto? <a href="#" id="showLogin">Zurück zur Anmeldung</a></p>
                <p id="registerError" style="color: red;"></p>
            </div>

            <hr style="width: 80%; border: 1px solid #ddd; margin: 20px 0;">

            <button id="googleLoginButton">
                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M44.5 20H24V28H35.5C34.7 32.7 30.6 35.5 24 35.5C18.6 35.5 13.9 31.8 11.9 26.5C11.3 25.1 11 23.6 11 22C11 20.4 11.3 18.9 11.9 17.5C13.9 12.2 18.6 8.5 24 8.5C28.2 8.5 31.7 10.1 34.3 12.7L39.1 7.9C35.2 4.1 29.8 2 24 2C13.8 2 5.5 9.7 2.7 20H44.5V20Z" fill="#F4B400"/>
                    <path d="M24 35.5C30.6 35.5 34.7 32.7 35.5 28H24V35.5Z" fill="#DB4437"/>
                    <path d="M11.9 26.5C11.3 25.1 11 23.6 11 22C11 20.4 11.3 18.9 11.9 17.5C13.9 12.2 18.6 8.5 24 8.5C28.2 8.5 31.7 10.1 34.3 12.7L39.1 7.9C35.2 4.1 29.8 2 24 2C13.8 2 5.5 9.7 2.7 20L11.9 26.5Z" fill="#4285F4"/>
                    <path d="M2.7 20C2.1 21.3 2 22.7 2 24C2 25.3 2.1 26.7 2.7 28L11.9 21.5L2.7 20Z" fill="#0F9D58"/>
                </svg>
                Mit Google anmelden
            </button>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div id="userInfo"></div>
        <div class="lobby-container" id="lobbyContainer">
            <h2>Lobby</h2>
            <p id="lobbyCodeDisplay">Lobby-Code: <span id="lobbyCode">---</span></p>
            <div id="lobbyActions" style="display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%;">
                <div style="display: flex; gap: 10px; width: 100%;">
                    <input type="text" id="joinLobbyInput" class="lobby-input" placeholder="Lobby-Code">
                    <button class="lobby-button" id="joinLobbyButton">Beitreten</button>
                </div>
                <button class="lobby-button" id="createLobbyButton">Lobby erstellen</button>
                <button class="lobby-button start-game-button" id="startGameButton">Spiel starten</button>
            </div>
            <p id="lobbyStatus" class="lobby-status"></p>
            <div class="player-list">
                <h3>Mitspieler</h3>
                <div id="player-list-container"></div>
            </div>
            <button class="button" id="logoutButton" style="margin-top: 20px;">Abmelden</button>
        </div>

        <div class="game-view" id="gameView" style="display: none;">
            <div class="level-info" id="level-info">Level 1</div>
            <canvas id="gameCanvas"></canvas>
            <div class="ui-panel">
                <div class="stats-container">
                    <div class="stat-item">
                        Lungenkapazität<br>
                        <span id="lungen-kapazitaet-text">100%</span>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="lungen-kapazitaet-bar"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        Stiele gesammelt<br>
                        <span id="stiele-counter">0 / 10</span>
                    </div>
                </div>
                <div class="info-message" id="info-message">Bewegen Sie sich mit den Pfeiltasten oder WASD. Sammeln Sie alle Stiele, um das Level zu beenden.</div>
                <div style="display: flex; gap: 10px;">
                    <button class="button" id="openDialogueButton">✨ Lass uns reden!</button>
                    <button class="button" id="returnToLobbyButton">Zurück zur Lobby</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay">
        <span id="overlay-text"></span>
    </div>

    <!-- Dialogue UI -->
    <div class="dialogue-overlay" id="dialogueOverlay">
        <div class="dialogue-box">
            <button class="dialogue-close-button" id="closeDialogueButton">&times;</button>
            <div class="dialogue-title">Herr Winkelmann sagt...</div>
            <div class="dialogue-text" id="dialogueText">Fragen Sie mich alles, aber bitte nicht, wie viele Stiele ich noch brauche... Bin schon ganz aus der Puste!</div>
            <div class="dialogue-input-container">
                <input type="text" id="dialogueInput" class="dialogue-input" placeholder="Stellen Sie eine Frage...">
                <button class="dialogue-button" id="sendDialogueButton">Senden</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, runTransaction, getDocs, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase-Konfiguration aus der Umgebung
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth;
        let userId;

        // UI element references
        const authContainer = document.getElementById('authContainer');
        const authForms = document.getElementById('authForms');
        const loadingMessage = document.getElementById('loadingMessage');
        const mainContainer = document.getElementById('mainContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerButton = document.getElementById('registerButton');
        const authError = document.getElementById('authError');
        const registerError = document.getElementById('registerError');
        const userInfoDisplay = document.getElementById('userInfo');
        const logoutButton = document.getElementById('logoutButton');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const playerListContainer = document.getElementById('player-list-container');
        
        // Lobby-spezifische UI
        const lobbyContainer = document.getElementById('lobbyContainer');
        const gameView = document.getElementById('gameView');
        const createLobbyButton = document.getElementById('createLobbyButton');
        const joinLobbyInput = document.getElementById('joinLobbyInput');
        const joinLobbyButton = document.getElementById('joinLobbyButton');
        const startGameButton = document.getElementById('startGameButton');
        const lobbyCodeDisplay = document.getElementById('lobbyCode');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const returnToLobbyButton = document.getElementById('returnToLobbyButton');

        // Multiplayer-spezifische Variablen
        let lobbyId = null;
        let isLobbyCreator = false;
        let isMultiplayerActive = false;
        let otherPlayers = {};
        let localPlayerState = {};
        let gameSessionListener = null;

        // Game-spezifische Variablen
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('overlay');
        const overlayText = document.getElementById('overlay-text');
        const lungenKapazitaetBar = document.getElementById('lungen-kapazitaet-bar');
        const lungenKapazitaetText = document.getElementById('lungen-kapazitaet-text');
        const stieleCounterText = document.getElementById('stiele-counter');
        const infoMessage = document.getElementById('info-message');
        const levelInfo = document.getElementById('level-info');
        
        const openDialogueButton = document.getElementById('openDialogueButton');
        const dialogueOverlay = document.getElementById('dialogueOverlay');
        const dialogueText = document.getElementById('dialogueText');
        const dialogueInput = document.getElementById('dialogueInput');
        const sendDialogueButton = document.getElementById('sendDialogueButton');
        const closeDialogueButton = document.getElementById('closeDialogueButton');
        
        let animationFrameId;
        let lastTime = 0;
        let keys = {};
        let isRunning = false;
        let gameData = { stiele: [] };
        let isSpeaking = false;
        let lowLungsWarning = false;
        
        const playerColors = ['#ff7e5f', '#4CAF50', '#4285F4', '#F4B400', '#DB4437', '#0F9D58'];
        let playerColor = playerColors[Math.floor(Math.random() * playerColors.length)];

        const baseSpeed = 250;
        const maxLungenKapazitaet = 100;
        const STIELE_PER_LEVEL = 10;
        
        let lobbiesCollectionRef;

        // Hauptanwendungsfluss, aufrufbar nach der Firebase-Initialisierung
        async function startAppFlow() {
            if (!auth || !db) {
                console.error("Firebase not initialized. Cannot start app flow.");
                loadingMessage.textContent = "Fehler: Firebase-Konfiguration ungültig. Bitte überprüfen Sie Ihre Daten.";
                return;
            }

            // Authentication Event Listeners
            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authError.textContent = '';
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                registerError.textContent = '';
            });

            loginButton.addEventListener('click', async () => {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                authError.textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    authError.textContent = 'Login fehlgeschlagen. Bitte überprüfen Sie E-Mail und Passwort.';
                    console.error("Login failed:", error);
                }
            });

            registerButton.addEventListener('click', async () => {
                const email = registerEmailInput.value;
                const password = registerPasswordInput.value;
                registerError.textContent = '';
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        registerError.textContent = 'Diese E-Mail-Adresse wird bereits verwendet.';
                    } else {
                        registerError.textContent = 'Registrierung fehlgeschlagen. Bitte versuchen Sie es erneut.';
                    }
                    console.error("Registration failed:", error);
                }
            });

            googleLoginButton.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                authError.textContent = '';
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    authError.textContent = 'Anmeldung mit Google fehlgeschlagen.';
                    console.error("Google login failed:", error);
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout failed:", error);
                }
            });
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    lobbiesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'lobbies');
                    userInfoDisplay.textContent = `Angemeldet als: ${user.email || 'Anonym'}`;
                    authContainer.style.display = 'none';
                    mainContainer.style.display = 'flex';
                    setupLobby();
                } else {
                    userInfoDisplay.textContent = '';
                    authContainer.style.display = 'flex';
                    mainContainer.style.display = 'none';
                    isMultiplayerActive = false;
                    console.log("User logged out.");
                    loadingMessage.style.display = 'none';
                    authForms.style.display = 'block';
                }
            });

            // Erster Anmeldeversuch mit dem bereitgestellten Token
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (e) {
                    console.error("Anmeldung mit benutzerdefiniertem Token fehlgeschlagen:", e);
                    loadingMessage.style.display = 'none';
                    authForms.style.display = 'block';
                }
            } else {
                 loadingMessage.style.display = 'none';
                 authForms.style.display = 'block';
            }
        }

        // --- Lobby-Funktionen ---
        function generateLobbyCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function setupLobby() {
            lobbyContainer.style.display = 'flex';
            gameView.style.display = 'none';
            lobbyCodeDisplay.textContent = '---';
            startGameButton.style.display = 'none';
            lobbyStatus.textContent = '';

            // Lese die Lobby-ID aus der URL, falls vorhanden
            const urlParams = new URLSearchParams(window.location.search);
            const urlLobbyId = urlParams.get('lobbyId');
            if (urlLobbyId) {
                joinLobbyInput.value = urlLobbyId;
                await joinLobby();
            } else {
                joinLobbyInput.value = '';
                lobbyCodeDisplay.textContent = '---';
                isLobbyCreator = false;
            }
        }
        
        createLobbyButton.addEventListener('click', async () => {
            const newLobbyId = generateLobbyCode();
            const lobbyDocRef = doc(lobbiesCollectionRef, newLobbyId);
            try {
                await setDoc(lobbyDocRef, {
                    creatorId: userId,
                    createdAt: new Date(),
                    status: 'waiting',
                });
                lobbyId = newLobbyId;
                isLobbyCreator = true;
                lobbyCodeDisplay.textContent = lobbyId;
                lobbyStatus.textContent = 'Warten auf Spieler...';
                joinLobbyInput.value = lobbyId;
                startGameButton.style.display = 'block';
                createLobbyButton.style.display = 'none';
                joinLobbyButton.style.display = 'none';
                listenToLobby();
            } catch (e) {
                console.error("Fehler beim Erstellen der Lobby:", e);
                lobbyStatus.textContent = "Fehler beim Erstellen der Lobby. Bitte versuchen Sie es erneut.";
            }
        });

        joinLobbyButton.addEventListener('click', async () => {
            await joinLobby();
        });

        async function joinLobby() {
            const code = joinLobbyInput.value.trim();
            if (code.length !== 6) {
                lobbyStatus.textContent = 'Der Lobby-Code muss 6 Ziffern lang sein.';
                return;
            }
            const lobbyDocRef = doc(lobbiesCollectionRef, code);
            try {
                const docSnap = await getDoc(lobbyDocRef);
                if (docSnap.exists()) {
                    lobbyId = code;
                    isLobbyCreator = false;
                    lobbyCodeDisplay.textContent = lobbyId;
                    lobbyStatus.textContent = 'Erfolgreich beigetreten. Warten auf Spielstart...';
                    createLobbyButton.style.display = 'none';
                    joinLobbyInput.style.display = 'none';
                    joinLobbyButton.style.display = 'none';
                    listenToLobby();
                } else {
                    lobbyStatus.textContent = 'Lobby nicht gefunden. Ungültiger Code.';
                }
            } catch (e) {
                console.error("Fehler beim Beitreten der Lobby:", e);
                lobbyStatus.textContent = "Fehler beim Beitreten der Lobby. Bitte versuchen Sie es erneut.";
            }
        }

        function listenToLobby() {
            if (gameSessionListener) gameSessionListener();
            
            const playersCollectionRef = collection(lobbiesCollectionRef, lobbyId, 'players');
            onSnapshot(playersCollectionRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const playerData = change.doc.data();
                    const playerId = change.doc.id;
                    if (playerId === userId) return;
                    if (change.type === 'removed') {
                        delete otherPlayers[playerId];
                    } else {
                        otherPlayers[playerId] = playerData;
                    }
                });
                updatePlayerListUI();
            });

            const lobbyDocRef = doc(lobbiesCollectionRef, lobbyId);
            gameSessionListener = onSnapshot(lobbyDocRef, (docSnap) => {
                const data = docSnap.data();
                if (data && data.status === 'playing') {
                    if (isRunning) return; // Prevent multiple starts
                    initializeGame();
                }
                if (data && data.status === 'finished' && data.winner) {
                    endGame(true, data.winner);
                } else if (data && data.status === 'finished') {
                    endGame(false, null);
                }
            });

            // Put local player into the lobby
            setDoc(doc(playersCollectionRef, userId), {
                email: auth.currentUser.email || 'Anonym',
                color: playerColor,
                lastActive: new Date(),
                isCreator: isLobbyCreator,
                stiele: 0,
            }, { merge: true });
            
            updatePlayerListUI();
        }

        startGameButton.addEventListener('click', async () => {
            if (isLobbyCreator) {
                try {
                    const lobbyDocRef = doc(lobbiesCollectionRef, lobbyId);
                    await setDoc(lobbyDocRef, { status: 'playing', requiredStiele: STIELE_PER_LEVEL, winner: null }, { merge: true });
                } catch (e) {
                    console.error("Fehler beim Starten des Spiels:", e);
                }
            }
        });

        returnToLobbyButton.addEventListener('click', async () => {
            isRunning = false;
            cancelAnimationFrame(animationFrameId);
            // Delete player from current lobby
            await deleteDoc(doc(lobbiesCollectionRef, lobbyId, 'players', userId));
            lobbyId = null;
            isLobbyCreator = false;
            otherPlayers = {};
            setupLobby();
        });
        
        // --- Spiel-Funktionen ---
        async function initializeGame() {
            lobbyContainer.style.display = 'none';
            gameView.style.display = 'flex';
            
            localPlayerState = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                width: 30,
                height: 30,
                speed: baseSpeed,
                stiele: 0,
                lungenKapazitaet: maxLungenKapazitaet
            };
            
            gameData = { stiele: [] };

            // Start a listener for game stiele
            const stieleCollectionRef = collection(lobbiesCollectionRef, lobbyId, 'stiele');
            onSnapshot(stieleCollectionRef, (snapshot) => {
                 gameData.stiele = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });

            if (isLobbyCreator) {
                // If we are the creator, generate new stiele for the game
                await generateStiele(STIELE_PER_LEVEL);
            }
            
            draw();
            updateUI();
            startGame();
        }
        
        async function generateStiele(count) {
            const stieleCollectionRef = collection(lobbiesCollectionRef, lobbyId, 'stiele');
            for (let i = 0; i < count; i++) {
                const pos = getNonOverlappingPosition([], 15, 15);
                await addDoc(stieleCollectionRef, { x: pos.x, y: pos.y, width: 15, height: 15, color: '#ff7e5f' });
            }
        }

        async function getNonOverlappingPosition(existingObjects, width, height) {
            let newPos, overlapping;
            do {
                overlapping = false;
                newPos = {
                    x: Math.random() * (canvas.width - width),
                    y: Math.random() * (canvas.height - height),
                    y: Math.random() * (canvas.height - height),
                    width: width,
                    height: height
                };
            } while (overlapping);
            return newPos;
        }

        async function startGame() {
             overlay.classList.remove('active');
             if (!isRunning) {
                 isRunning = true;
                 isMultiplayerActive = true;
                 lastTime = performance.now();
                 animationFrameId = requestAnimationFrame(gameLoop);
                 infoMessage.textContent = "Sammle die Stiele, bevor die Lungenkapazitaet aufgebraucht ist!";
                 speak("Los geht's! Nur nicht schlapp machen!", "Puck");
             }
         }

        function gameLoop(time) {
            const deltaTime = (time - lastTime) / 1000;
            lastTime = time;

            if (isRunning) {
                update(deltaTime);
                draw();
                animationFrameId = requestAnimationFrame(gameLoop);
            }
        }

        function update(deltaTime) {
            const speed = baseSpeed;
            let dx = 0;
            let dy = 0;
            if (keys['arrowup'] || keys['w']) dy = -1;
            if (keys['arrowdown'] || keys['s']) dx = -1;
            if (keys['arrowleft'] || keys['a']) dx = -1;
            if (keys['arrowright'] || keys['d']) dx = 1;

            if (dx !== 0 || dy !== 0) {
                const length = Math.sqrt(dx * dx + dy * dy);
                if (length > 0) {
                    localPlayerState.x += (dx / length) * speed * deltaTime;
                    localPlayerState.y += (dy / length) * speed * deltaTime;
                }
            }

            localPlayerState.x = Math.max(0, Math.min(canvas.width - localPlayerState.width, localPlayerState.x));
            localPlayerState.y = Math.max(0, Math.min(canvas.height - localPlayerState.height, localPlayerState.y));

            localPlayerState.lungenKapazitaet -= 1 * deltaTime;
            if (localPlayerState.lungenKapazitaet <= 0) {
                // Game over, return to lobby
                return;
            }
            
            if (localPlayerState.lungenKapazitaet < 20 && !lowLungsWarning) {
                speak("Uff... die Luft wird knapp!", "Orus");
                lowLungsWarning = true;
            } else if (localPlayerState.lungenKapazitaet > 20) {
                lowLungsWarning = false;
            }
            
            gameData.stiele.forEach(stiel => {
                if (checkCollision(localPlayerState, stiel)) {
                    try {
                        runTransaction(db, async (transaction) => {
                            const stielRef = doc(lobbiesCollectionRef, lobbyId, 'stiele', stiel.id);
                            const stielDoc = await transaction.get(stielRef);
                            
                            if (stielDoc.exists()) {
                                transaction.delete(stielRef);
                                
                                const playerRef = doc(lobbiesCollectionRef, lobbyId, 'players', userId);
                                transaction.update(playerRef, { stiele: (localPlayerState.stiele || 0) + 1 });
                                localPlayerState.stiele++;
                                localPlayerState.lungenKapazitaet = Math.min(maxLungenKapazitaet, localPlayerState.lungenKapazitaet + 10);
                            
                                const lobbyDocRef = doc(lobbiesCollectionRef, lobbyId);
                                const lobbyDoc = await transaction.get(lobbyDocRef);
                                const requiredStiele = lobbyDoc.data().requiredStiele;

                                if (gameData.stiele.length - 1 <= 0) {
                                     transaction.update(lobbyDocRef, { winner: userId, status: 'finished' });
                                }
                            }
                        });
                    } catch (e) {
                        console.error("Transaktion fehlgeschlagen: ", e);
                    }
                }
            });

            // Update local player state in Firebase
            updateLocalPlayerState();

            updateUI();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            gameData.stiele.forEach(stiel => {
                ctx.beginPath();
                ctx.arc(stiel.x + stiel.width / 2, stiel.y + stiel.height / 2, stiel.width / 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#ff7e5f';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            for (const playerId in otherPlayers) {
                const player = otherPlayers[playerId];
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, localPlayerState.width, localPlayerState.height);
                
                ctx.fillStyle = 'black';
                ctx.font = '12px Roboto Mono';
                ctx.textAlign = 'center';
                ctx.fillText(player.email.split('@')[0], player.x + localPlayerState.width / 2, player.y - 5);
            }

            ctx.fillStyle = playerColor;
            ctx.fillRect(localPlayerState.x, localPlayerState.y, localPlayerState.width, localPlayerState.height);

            ctx.fillStyle = 'black';
            ctx.font = '12px Roboto Mono';
            ctx.textAlign = 'center';
            ctx.fillText('Sie', localPlayerState.x + localPlayerState.width / 2, localPlayerState.y - 5);
        }

        function updateUI() {
            const lungenProzent = Math.max(0, (localPlayerState.lungenKapazitaet / maxLungenKapazitaet) * 100);
            lungenKapazitaetBar.style.width = `${lungenProzent}%`;
            lungenKapazitaetText.textContent = `${Math.floor(lungenProzent)}%`;

            const lungenColor = lungenProzent > 50 ? '#4CAF50' : (lungenProzent > 20 ? '#FFC107' : '#F4436');
            lungenKapazitaetBar.style.background = `linear-gradient(90deg, ${lungenColor}, ${lungenProzent > 50 ? '#8bc34a' : (lungenProzent > 20 ? '#ffeb3b' : '#ff7979')})`;
            
            stieleCounterText.textContent = `${localPlayerState.stiele} / ${STIELE_PER_LEVEL}`;
            levelInfo.textContent = `Spiel läuft`;
        }

        function updatePlayerListUI() {
            const allPlayers = {
                ...otherPlayers,
                [userId]: {
                    email: auth.currentUser.email || 'Anonym',
                    stiele: localPlayerState.stiele || 0,
                    color: playerColor,
                }
            };
            
            const sortedPlayers = Object.entries(allPlayers).sort(([, a], [, b]) => b.stiele - a.stiele);
            
            playerListContainer.innerHTML = '';
            sortedPlayers.forEach(([id, player]) => {
                const isCurrentUser = id === userId;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item' + (isCurrentUser ? ' current' : '');
                playerDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 10px; height: 10px; border-radius: 50%; background-color: ${player.color};"></div>
                        <span>${player.email.split('@')[0]}</span>
                    </div>
                    <span>${player.stiele} Stiele</span>
                `;
                playerListContainer.appendChild(playerDiv);
            });
        }


        function showOverlay(text) {
            overlayText.textContent = text;
            overlay.classList.add('active');
        }

        async function endGame(isWin, winnerId = null) {
            isRunning = false;
            isMultiplayerActive = false;
            cancelAnimationFrame(animationFrameId);
            
            let message;
            if (isWin) {
                const winnerEmail = otherPlayers[winnerId]?.email || auth.currentUser.email || 'Anonym';
                const winnerName = winnerEmail.split('@')[0];
                message = `${winnerName} hat gewonnen!`;
                showOverlay(message);
                speak("Das war eine Meisterleistung!", "Zephyr");
            } else {
                message = "Da gibt's nichts mehr...";
                showOverlay(message);
                speak(message, "Charon");
            }
            
            // Wait a bit and then return to lobby
            setTimeout(() => {
                lobbyContainer.style.display = 'flex';
                gameView.style.display = 'none';
                
                // Clear state for next game
                lobbyCodeDisplay.textContent = lobbyId;
                lobbyStatus.textContent = isLobbyCreator ? 'Das Spiel ist beendet. Starten Sie ein neues Spiel.' : 'Das Spiel ist beendet. Warten auf den Start des nächsten Spiels.';
                if (isLobbyCreator) {
                    startGameButton.style.display = 'block';
                }
            }, 3000);
        }

        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Event-Listener
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'].includes(e.key.toLowerCase())) {
                keys[e.key.toLowerCase()] = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        openDialogueButton.addEventListener('click', () => {
            if (isRunning) {
                 isRunning = false;
                 cancelAnimationFrame(animationFrameId);
            }
            dialogueOverlay.style.display = 'flex';
        });
        closeDialogueButton.addEventListener('click', () => {
            dialogueOverlay.style.display = 'none';
            if (!isRunning) {
                startGame();
            }
        });
        sendDialogueButton.addEventListener('click', () => {
            const userQuery = dialogueInput.value.trim();
            if (userQuery) {
                generateAndSpeakResponse(userQuery);
                dialogueInput.value = '';
            }
        });
        dialogueInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendDialogueButton.click();
            }
        });

        // --- Gemini TTS API Integration ---
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=";
        const API_KEY = "AIzaSyCoP3TRsVluxrVXVxeZ_lJfeOyqrNbbGa0";

        async function speak(text, voiceName = "Kore") {
            if (isSpeaking) return;
            isSpeaking = true;
            
            try {
                const payload = {
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(TTS_API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        isSpeaking = false;
                    };
                } else {
                    throw new Error("Invalid audio data from API");
                }
            } catch (error) {
                console.error("Failed to generate speech:", error);
                isSpeaking = false;
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);

            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);

            const blob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
            return blob;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        // --- End of Gemini TTS API Integration ---

        // --- Gemini LLM Dialogue Integration ---
        const LLM_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const systemPrompt = `Du bist Herr Winkelmann, ein sehr höflicher, leicht außer Atem geratener Mann, der damit beschäftigt ist, Stiele einzusammeln. Antworte immer kurz, freundlich und in der Ich-Form. Deine Antworten sollten widerspiegeln, dass du dich gerade anstrengst, aber fest entschlossen bist. Beziehe dich auf deine aktuelle Aufgabe, wenn es passt. Du bist ein einfacher Mann. Vermeide übermäßig komplexe Sprache.`;
        let isGeneratingResponse = false;

        async function generateAndSpeakResponse(userQuery) {
            if (isGeneratingResponse) return;
            isGeneratingResponse = true;
            sendDialogueButton.disabled = true;
            dialogueInput.disabled = true;
            dialogueText.textContent = "Herr Winkelmann denkt nach...";

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(LLM_API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    dialogueText.textContent = text;
                    await speak(text, "Leda");
                } else {
                    throw new Error("Invalid response from LLM API");
                }
            } catch (error) {
                console.error("Failed to generate dialogue:", error);
                dialogueText.textContent = "Huch, etwas ist schiefgelaufen. Ich kann jetzt nicht reden.";
            } finally {
                isGeneratingResponse = false;
                sendDialogueButton.disabled = false;
                dialogueInput.disabled = false;
            }
        }
        // --- End of Gemini LLM Dialogue Integration ---
        
        function resizeCanvas() {
            canvas.width = window.innerWidth * 0.7;
            canvas.height = window.innerHeight * 0.7;
            if (canvas.width > 800) canvas.width = 800;
            if (canvas.height > 600) canvas.height = 600;
        }

        async function updateLocalPlayerState() {
            if (!isMultiplayerActive || !userId || !lobbyId) return;
            try {
                const playersCollectionRef = collection(lobbiesCollectionRef, lobbyId, 'players');
                await setDoc(doc(playersCollectionRef, userId), {
                    x: localPlayerState.x,
                    y: localPlayerState.y,
                    stiele: localPlayerState.stiele,
                    email: auth.currentUser.email || 'Anonym',
                    color: playerColor,
                    lastActive: new Date(),
                }, { merge: true });
            } catch (e) {
                console.error("Fehler beim Aktualisieren des Spielerstatus:", e);
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
            startAppFlow();
        } catch (e) {
            console.error("Firebase initialization failed. Please check the provided firebaseConfig.", e);
            loadingMessage.textContent = "Fehler: Verbindung zur Datenbank fehlgeschlagen. Bitte versuchen Sie es später erneut.";
            loadingMessage.style.color = "red";
            loadingMessage.style.fontSize = "1.2em";
            loadingMessage.style.fontWeight = "bold";
        }
    </script>
</body>
</html>
